# NFe åˆ†æå·¥å…·ï¼šåˆ†æå‘ç¥¨å„ç±»ç¨åŠ¡æ”¯ä»˜é‡‘é¢å æ¯”ç­‰ç­‰

è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸ºåŠ è½½å’Œåˆ†æå·´è¥¿ç”µå­å‘ç¥¨ï¼ˆNFeï¼‰XMLæ–‡ä»¶è€Œè®¾è®¡çš„å·¥å…·ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†ä¸ç›´è§‚æ•°æ®åˆ†æï¼Œå¹¶å¯å°†ç»“æœå¯¼å‡º XLSX æ ¼å¼è¿›è¡Œæ›´ç»†è‡´çš„åˆ†æå‘ç¥¨æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå½“ Bling å¹³å°æˆ–è€…å…¶ä»–ä»»æ„å¹³å°æ— æ³•æ ¹æ®æ‰€éœ€è¦çš„ç»´åº¦æ¸…æ™°å‘ˆç°å‘ç¥¨ç›¸å…³æ•°æ®æ—¶ï¼Œæ‚¨å¯ä»¥ä» å¹³å°ä¸­ å¯¼å‡ºé”€å”®å•ä¸ªæˆ–å¤šä¸ªå‘ç¥¨çš„ XML æ–‡ä»¶ï¼Œå€ŸåŠ©æœ¬ç¨‹åºè¿›è¡Œæ·±å…¥è§£æå’Œåˆ†æã€‚
![image](https://github.com/user-attachments/assets/20903e31-5d53-47ff-a29a-62fa1bee979f)


---

## æ ¸å¿ƒåŠŸèƒ½

### ğŸ“Š **æ™ºèƒ½æ•°æ®åˆ†æ**
- æ‰¹é‡å¯¼å…¥ NFe XML æ–‡ä»¶ï¼Œæ”¯æŒå¤šæ–‡ä»¶åŒæ—¶åˆ†æ
- è‡ªåŠ¨ç”Ÿæˆå…³é”®ç»Ÿè®¡æŒ‡æ ‡
- æ·±å…¥è§£æç¨æ”¶æ•°æ®ï¼ˆå¦‚ **ICMS**ã€**PIS**ã€**COFINS** ç­‰ï¼‰
- å•†å“å’Œå®¢æˆ·æ•°æ®ç»Ÿè®¡ï¼ŒåŠ©æ‚¨å…¨é¢æŒæ¡ä¸šåŠ¡çŠ¶å†µ

### ğŸ“ˆ **æ¸…æ™°ç›´è§‚çš„æ•°æ®å±•ç¤º**
- å¤šæ ‡ç­¾é¡µé¢è®¾è®¡ï¼Œåˆ†ç±»ä¿¡æ¯ä¸€ç›®äº†ç„¶
- æ•°æ®æ˜ç»†è¡¨æ ¼ï¼Œå±•ç¤ºæ¯å¼ å‘ç¥¨çš„è¯¦ç»†å†…å®¹
- å‘ç¥¨æ±‡æ€»å’Œç»Ÿè®¡åˆ†æé¢æ¿ï¼Œå¿«é€ŸæŒæ¡æ•´ä½“æƒ…å†µ

### ğŸ’¾ **é«˜æ•ˆçš„æ•°æ®å¤„ç†ä¸å¯¼å‡º**
- ä¸€é”®å¯¼å‡ºåˆ†æç»“æœåˆ° Excelï¼ˆXLSX æ ¼å¼ï¼‰
- æ”¯æŒæ™ºèƒ½æ•°æ®è¿‡æ»¤ä¸æœç´¢ï¼Œæ–¹ä¾¿å®šä½å…³é”®æ•°æ®
- å‹å¥½çš„ç•Œé¢è®¾è®¡ï¼Œæ“ä½œæµç•…ï¼Œæ— éœ€ä¸“ä¸šæŠ€èƒ½

---

## å®‰è£…ä¸è¿è¡Œ

### **ç³»ç»Ÿè¦æ±‚**
- **Python** ç‰ˆæœ¬ï¼š3.7+
- æ“ä½œç³»ç»Ÿï¼šWindowsã€macOS æˆ– Linux

### **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

### **ä¾èµ–åŒ…æ¸…å•**
- **tkinter**ï¼šç”¨æˆ·ç•Œé¢
- **ttkbootstrap**ï¼šç°ä»£åŒ–æ ·å¼
- **openpyxl**ï¼šExcel æ•°æ®å¤„ç†
- **xml.etree.ElementTree**ï¼šXML æ–‡ä»¶è§£æ

### **å¿«é€Ÿå¯åŠ¨**
1. å¯åŠ¨ç¨‹åºï¼š
   ```bash
   python nfe_analyzer.py
   ```
2. å¯¼å…¥æ–‡ä»¶ï¼š
   - ç‚¹å‡»â€œé€‰æ‹© NFe æ–‡ä»¶â€æŒ‰é’®
   - æ‰¹é‡é€‰æ‹© XML æ ¼å¼çš„ NFe æ–‡ä»¶
![image](https://github.com/user-attachments/assets/33e54baf-6515-450d-8852-defa80972a9b)

3. æŸ¥çœ‹åˆ†æç»“æœï¼š
   - åœ¨â€œæ•°æ®æ˜ç»†â€é¡µæŸ¥çœ‹å‘ç¥¨è¯¦æƒ…
![image](https://github.com/user-attachments/assets/1efe9a65-9749-41b8-9949-be7e254bb155)

   - åœ¨â€œå‘ç¥¨åˆ†æâ€é¡µäº†è§£æ•´ä½“æƒ…å†µ
![image](https://github.com/user-attachments/assets/aaa43e32-3d64-40d6-8054-2167ab53848e)

   - åœ¨â€œç»Ÿè®¡åˆ†æâ€é¡µè·å–æ•°æ®æ´å¯Ÿ
![image](https://github.com/user-attachments/assets/e64928fc-f3eb-4b7a-9d67-e74b93e47583)


4. å¯¼å‡ºæ•°æ®ï¼š
   - ç‚¹å‡»â€œå¯¼å‡º Excelâ€æŒ‰é’®ï¼Œç”Ÿæˆè‡ªå®šä¹‰åˆ†ææŠ¥å‘Š

---

## äº®ç‚¹åŠŸèƒ½

### ğŸ¯ **æ·±åº¦æ•°æ®æ´å¯Ÿ**
- å‘ç¥¨æ€»é‡ç»Ÿè®¡
- å•†å“é”€é‡ä¸å®¢æˆ·æ•°æ®åˆ†æ
- å„ç±»ç¨æ”¶ç»Ÿè®¡
- é”€å”®é¢ä»·æ ¼åŒºé—´åˆ†æ

### ğŸ›  **æŠ€æœ¯ä¼˜åŠ¿**
- ç°ä»£åŒ–ç”¨æˆ·ç•Œé¢ï¼Œç®€æ´é«˜æ•ˆ
- å¿«é€Ÿå“åº”çš„å¤§æ•°æ®å¤„ç†æœºåˆ¶
- å¹³æ»‘æ»šåŠ¨ä¸é˜²æŠ–åŠ¨è®¾è®¡ï¼Œæå‡æ“ä½œä½“éªŒ

---

é€šè¿‡è¯¥å·¥å…·ï¼Œæ‚¨å¯ä»¥è½»æ¾æå–ã€åˆ†æå’Œå¯¼å‡ºå‘ç¥¨æ•°æ®ï¼Œä¸ºä¸šåŠ¡å†³ç­–æä¾›æœ‰åŠ›æ”¯æŒã€‚ä¸è®ºæ˜¯ä¼ä¸šä¸»ã€ä¼šè®¡å¸ˆè¿˜æ˜¯è´¢åŠ¡åˆ†æå¸ˆï¼Œè¿™æ¬¾å·¥å…·éƒ½èƒ½åŠ©æ‚¨é«˜æ•ˆå®Œæˆå·¥ä½œã€‚

å¯¹è¯¥ç¨‹åºæœ‰ç–‘æƒ‘æˆ–è€…éœ€è¦æŠ€æœ¯æ”¯æŒï¼Œå¯è”ç³»Whatsappï¼š(11)95925-8788 æˆ– å¾®ä¿¡
![e17a3d71a6a8aceee0e60c010306a36](https://github.com/user-attachments/assets/e10eda57-956a-4000-ad7a-3c1422bd98ab)

 ```python
    def _init_data(self):
        """é‡ç½®æ•°æ®åˆ°åˆå§‹çŠ¶æ€"""
        # æ¸…é™¤æ•°æ®
        self.loaded_files.clear()
        self.invoice_data.clear()
        
        # é‡ç½®é˜²æŠ–åŠ¨è®¾ç½®
        self._scroll_update_pending = False
        self._last_scroll_time = 0
        
    def _on_tab_changed(self, event):
        """å¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶"""
        tab = self.notebook.select()
        tab_text = self.notebook.tab(tab, "text")
        
        # æ·»åŠ åˆ‡æ¢åŠ¨ç”»æ•ˆæœ
        self.notebook.update_idletasks()
        
        # æ›´æ–°å½“å‰é¡µé¢æ•°æ®
        if tab_text == "ç»Ÿè®¡åˆ†æ":
            self.update_summary_display()
        elif tab_text == "å‘ç¥¨åˆ†æ":
            self.update_invoice_display()
        
    def create_control_panel(self):
        """åˆ›å»ºæ§åˆ¶é¢æ¿"""
        control_frame = ttk.Frame(self.main_frame, style="Card.TFrame")
        control_frame.pack(fill=tk.X, pady=(0, 10))
        
        # æ–‡ä»¶æ“ä½œæŒ‰é’®
        btn_frame = ttk.Frame(control_frame, style="Card.TFrame")
        btn_frame.pack(side=tk.LEFT, padx=10, pady=5)
        
        buttons = [
            ("é€‰æ‹©NFeæ–‡ä»¶", self.select_files, "primary"),
            ("å¯¼å‡ºExcel", self.export_to_excel, "info"),
            ("æ¸…é™¤æ‰€æœ‰", self.clear_all, "secondary")
        ]
        
        for text, command, style in buttons:
            btn = ttk.Button(
            btn_frame,
                text=text,
                command=command,
                style=f"{style}.TButton",
            width=15
        )
            btn.pack(side=tk.LEFT, padx=5)
            
            # æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
            btn.bind('<Enter>', lambda e, b=btn: self._on_button_hover(e, b))
            btn.bind('<Leave>', lambda e, b=btn: self._on_button_leave(e, b))
        
        # æ–‡ä»¶åˆ—è¡¨
        file_list_frame = ttk.LabelFrame(
            control_frame,
            text="å·²åŠ è½½æ–‡ä»¶",
            style="Card.TLabelframe"
        )
        file_list_frame.pack(fill=tk.X, padx=(20, 10), pady=5)
        
        # åˆ›å»ºæ–‡ä»¶æ ‘å½¢è§†å›¾
        self.file_tree = ttk.Treeview(
            file_list_frame,
            columns=("æ–‡ä»¶å", "çŠ¶æ€"),
            show="headings",
            height=3,
            style="Treeview"
        )
        
        # è®¾ç½®åˆ—
        self.file_tree.heading("æ–‡ä»¶å", text="æ–‡ä»¶å")
        self.file_tree.heading("çŠ¶æ€", text="çŠ¶æ€")
        self.file_tree.column("æ–‡ä»¶å", width=300)
        self.file_tree.column("çŠ¶æ€", width=100)
        
        # æ·»åŠ æ»šåŠ¨æ¡
        scrollbar = ttk.Scrollbar(
            file_list_frame,
            orient=tk.VERTICAL,
            command=self.file_tree.yview,
            style="Smooth.Vertical.TScrollbar"
        )
        
        self.file_tree.configure(yscrollcommand=scrollbar.set)
        
        # å¸ƒå±€
        self.file_tree.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5, pady=5)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y, pady=5)
        
        # ç»‘å®šé¼ æ ‡æ»šè½®äº‹ä»¶
        self.file_tree.bind("<Enter>", self._bind_mousewheel)
        self.file_tree.bind("<Leave>", self._unbind_mousewheel)
        
    def _on_button_hover(self, event, button):
        """å¤„ç†æŒ‰é’®æ‚¬åœäº‹ä»¶"""
        style = str(button.cget('style')).split('.')[0]
        button.configure(cursor="hand2")
        self.style.configure(
            f"{style}.TButton",
            background=self.colors['hover']
        )
        
    def _on_button_leave(self, event, button):
        """å¤„ç†æŒ‰é’®ç¦»å¼€äº‹ä»¶"""
        style = str(button.cget('style')).split('.')[0]
        button.configure(cursor="")
        self.style.configure(
            f"{style}.TButton",
            background=self.colors[style.lower()]
        )
        
    def create_data_page(self):
        """åˆ›å»ºæ•°æ®æ˜ç»†é¡µé¢"""
        data_page = ttk.Frame(self.notebook, style="Card.TFrame")
        self.notebook.add(data_page, text="æ•°æ®æ˜ç»†")
        
        # åˆ›å»ºæ•°æ®æ˜¾ç¤ºåŒºåŸŸ
        data_frame = ttk.Frame(data_page, style="Card.TFrame")
        data_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # åˆ›å»ºå®¹å™¨æ¡†æ¶
        container = ttk.Frame(data_frame, style="Card.TFrame")
        container.pack(fill=tk.BOTH, expand=True)
        
        # å®šä¹‰åˆ—
        columns = (
            "å‘ç¥¨å·ç ", "ç³»åˆ—å·", "å‘ç¥¨æ—¥æœŸ", "æ“ä½œæ€§è´¨", "æ‰“å°ç±»å‹", "å‡ºå…·ç±»å‹",
            "å®¢æˆ·åç§°", "å®¢æˆ·CNPJ", "å®¢æˆ·åœ°å€",
            "äº§å“ä»£ç ", "äº§å“åç§°", "NCM", "æ•°é‡", "å•ä»·", "æ€»ä»·",
            "ICMSåŸå§‹ç¨ç‡", "ICMSåº”çº³ç¨é¢",
            "PISç¨ç‡", "PISåº”çº³ç¨é¢",
            "COFINSç¨ç‡", "COFINSåº”çº³ç¨é¢"
        )
        
        # åˆ›å»ºæ ‘å½¢è§†å›¾
        self.tree = ttk.Treeview(
            container,
            columns=columns,
            show="headings",
            style="Treeview"
        )
        
        # è®¾ç½®åˆ—å®½å’Œæ ‡é¢˜
        widths = {
            "å‘ç¥¨å·ç ": 80,
            "ç³»åˆ—å·": 60,
            "å‘ç¥¨æ—¥æœŸ": 100,
            "æ“ä½œæ€§è´¨": 150,
            "æ‰“å°ç±»å‹": 80,
            "å‡ºå…·ç±»å‹": 80,
            "å®¢æˆ·åç§°": 200,
            "å®¢æˆ·CNPJ": 120,
            "å®¢æˆ·åœ°å€": 250,
            "äº§å“ä»£ç ": 100,
            "äº§å“åç§°": 250,
            "NCM": 80,
            "æ•°é‡": 80,
            "å•ä»·": 100,
            "æ€»ä»·": 100,
            "ICMSåŸå§‹ç¨ç‡": 100,
            "ICMSåº”çº³ç¨é¢": 100,
            "PISç¨ç‡": 80,
            "PISåº”çº³ç¨é¢": 100,
            "COFINSç¨ç‡": 80,
            "COFINSåº”çº³ç¨é¢": 100
        }
        
        for col in columns:
            self.tree.heading(col, text=col)
            self.tree.column(col, width=widths.get(col, 100))
        
        # æ·»åŠ æ»šåŠ¨æ¡
        v_scrollbar = ttk.Scrollbar(
            container,
            orient=tk.VERTICAL,
            command=self.tree.yview,
            style="Smooth.Vertical.TScrollbar"
        )
        
        h_scrollbar = ttk.Scrollbar(
            container,
            orient=tk.HORIZONTAL,
            command=self.tree.xview,
            style="Smooth.Horizontal.TScrollbar"
        )
        
        # é…ç½®æ»šåŠ¨ç»‘å®š
        self.tree.configure(
            yscrollcommand=lambda *args: self._debounced_scroll(v_scrollbar, *args),
            xscrollcommand=lambda *args: self._debounced_scroll(h_scrollbar, *args)
        )
        
        # ä½¿ç”¨ç½‘æ ¼å¸ƒå±€
        self.tree.grid(row=0, column=0, sticky="nsew", padx=5, pady=5)
        v_scrollbar.grid(row=0, column=1, sticky="ns")
        h_scrollbar.grid(row=1, column=0, sticky="ew")
        
        # é…ç½®ç½‘æ ¼æƒé‡
        container.grid_rowconfigure(0, weight=1)
        container.grid_columnconfigure(0, weight=1)
        
        # ç»‘å®šäº‹ä»¶
        self.tree.bind("<Double-1>", self._on_tree_double_click)
        
        # ç»‘å®šæ»šåŠ¨äº‹ä»¶
        self.tree.bind("<Enter>", lambda e: (self._bind_mousewheel(e), self._bind_shift_mousewheel(e)))
        self.tree.bind("<Leave>", lambda e: (self._unbind_mousewheel(e), self._unbind_shift_mousewheel(e)))
        
    def _on_tree_double_click(self, event):
        """å¤„ç†æ ‘å½¢è§†å›¾åŒå‡»äº‹ä»¶"""
        item = self.tree.selection()[0]
        values = self.tree.item(item)["values"]
        if values:
            # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†
            self._show_detail_dialog(values)
            
    def _show_detail_dialog(self, values):
        """æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å¯¹è¯æ¡†"""
        dialog = tk.Toplevel(self)
        dialog.title("è¯¦ç»†ä¿¡æ¯")
        dialog.geometry("600x400")
        
        # è®¾ç½®å¯¹è¯æ¡†æ ·å¼
        frame = ttk.Frame(dialog, style="Card.TFrame")
        frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        headers = [
            "å‘ç¥¨å·ç ", "ç³»åˆ—å·", "å‘ç¥¨æ—¥æœŸ", "æ“ä½œæ€§è´¨", "æ‰“å°ç±»å‹", "å‡ºå…·ç±»å‹",
            "å®¢æˆ·åç§°", "å®¢æˆ·CNPJ", "å®¢æˆ·åœ°å€",
            "äº§å“ä»£ç ", "äº§å“åç§°", "NCM", "æ•°é‡", "å•ä»·", "æ€»ä»·",
            "ICMSåŸå§‹ç¨ç‡", "ICMSåº”çº³ç¨é¢",
            "PISç¨ç‡", "PISåº”çº³ç¨é¢",
            "COFINSç¨ç‡", "COFINSåº”çº³ç¨é¢"
        ]
        
        for i, (header, value) in enumerate(zip(headers, values)):
            row = ttk.Frame(frame, style="Card.TFrame")
            row.pack(fill=tk.X, pady=2)
            
            ttk.Label(
                row,
                text=f"{header}:",
                style="Header.TLabel"
            ).pack(side=tk.LEFT, padx=5)
            
            ttk.Label(
                row,
                text=str(value),
                style="Value.TLabel"
            ).pack(side=tk.RIGHT, padx=5)
        
        # æ·»åŠ å…³é—­æŒ‰é’®
        ttk.Button(
            frame,
            text="å…³é—­",
            command=dialog.destroy,
            style="primary.TButton"
        ).pack(pady=20)
        
        # ä½¿å¯¹è¯æ¡†å±…ä¸­æ˜¾ç¤º
        dialog.transient(self)
        dialog.grab_set()
        self.wait_window(dialog)
        
    def create_invoice_analysis_page(self):
        """åˆ›å»ºå‘ç¥¨åˆ†æé¡µé¢"""
        invoice_page = ttk.Frame(self.notebook, style="Card.TFrame")
        self.notebook.add(invoice_page, text="å‘ç¥¨åˆ†æ")
        
        # åˆ›å»ºå‘ç¥¨åˆ—è¡¨æ¡†æ¶
        invoice_frame = ttk.LabelFrame(
            invoice_page,
            text="å‘ç¥¨åˆ—è¡¨",
            style="Card.TLabelframe"
        )
        invoice_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # åˆ›å»ºå·¥å…·æ 
        toolbar = ttk.Frame(invoice_frame, style="Card.TFrame")
        toolbar.pack(fill=tk.X, padx=5, pady=5)
        
        # æ·»åŠ æœç´¢æ¡†
        search_frame = ttk.Frame(toolbar, style="Card.TFrame")
        search_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        ttk.Label(
            search_frame,
            text="æœç´¢:",
            style="Header.TLabel"
        ).pack(side=tk.LEFT, padx=5)
        
        self.search_var = tk.StringVar()
        search_entry = ttk.Entry(
            search_frame,
            textvariable=self.search_var,
            width=40
        )
        search_entry.pack(side=tk.LEFT, padx=5)
        
        # æ·»åŠ è¿‡æ»¤æŒ‰é’®
        filter_btn = ttk.Button(
            toolbar,
            text="è¿‡æ»¤",
            style="info.TButton",
            width=10,
            command=self._apply_filter
        )
        filter_btn.pack(side=tk.RIGHT, padx=5)
        
        # åˆ›å»ºè¡¨æ ¼å®¹å™¨
        table_container = ttk.Frame(invoice_frame, style="Card.TFrame")
        table_container.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        # åˆ›å»ºå‘ç¥¨æ ‘å½¢è§†å›¾
        columns = (
            "å‘ç¥¨å·ç ", "å‘ç¥¨æ—¥æœŸ", "å®¢æˆ·åç§°", "å®¢æˆ·CNPJ", "å®¢æˆ·åœ°å€", 
            "äº§å“æ€»ä»·", "è¿è´¹", "æŠ˜æ‰£",
            "ICMSç¨ç‡", "ICMSç¨é¢", 
            "PISç¨ç‡", "PISç¨é¢", 
            "COFINSç¨ç‡", "COFINSç¨é¢"
        )
        
        self.invoice_tree = ttk.Treeview(
            table_container,
            columns=columns,
            show="headings",
            style="Treeview",
            height=20
        )
        
        # è®¾ç½®åˆ—å®½å’Œæ ‡é¢˜
        widths = {
            "å‘ç¥¨å·ç ": 100,
            "å‘ç¥¨æ—¥æœŸ": 100,
            "å®¢æˆ·åç§°": 200,
            "å®¢æˆ·CNPJ": 130,
            "å®¢æˆ·åœ°å€": 300,
            "äº§å“æ€»ä»·": 120,
            "è¿è´¹": 80,
            "æŠ˜æ‰£": 80,
            "ICMSç¨ç‡": 80,
            "ICMSç¨é¢": 120,
            "PISç¨ç‡": 80,
            "PISç¨é¢": 120,
            "COFINSç¨ç‡": 80,
            "COFINSç¨é¢": 120
        }
        
        for col in columns:
            self.invoice_tree.heading(col, text=col)
            self.invoice_tree.column(col, width=widths.get(col, 100))
        
        # æ·»åŠ æ»šåŠ¨æ¡
        v_scrollbar = ttk.Scrollbar(
            table_container,
            orient=tk.VERTICAL,
            command=self.invoice_tree.yview,
            style="Smooth.Vertical.TScrollbar"
        )
        
        h_scrollbar = ttk.Scrollbar(
            table_container,
            orient=tk.HORIZONTAL,
            command=self.invoice_tree.xview,
            style="Smooth.Horizontal.TScrollbar"
        )
        
        # é…ç½®æ»šåŠ¨ç»‘å®š
        self.invoice_tree.configure(
            yscrollcommand=lambda *args: self._debounced_scroll(v_scrollbar, *args),
            xscrollcommand=lambda *args: self._debounced_scroll(h_scrollbar, *args)
        )
        
        # ä½¿ç”¨packå¸ƒå±€
        self.invoice_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        v_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        h_scrollbar.pack(side=tk.BOTTOM, fill=tk.X)
        
        # ç»‘å®šäº‹ä»¶
        self.invoice_tree.bind("<Double-1>", self._on_invoice_double_click)
        self.search_var.trace("w", lambda *args: self._on_search_change())
        
        # ç»‘å®šæ»šåŠ¨äº‹ä»¶
        self.invoice_tree.bind("<Enter>", lambda e: (self._bind_mousewheel(e), self._bind_shift_mousewheel(e)))
        self.invoice_tree.bind("<Leave>", lambda e: (self._unbind_mousewheel(e), self._unbind_shift_mousewheel(e)))
        
    def _apply_filter(self):
        """åº”ç”¨è¿‡æ»¤å™¨"""
        search_text = self.search_var.get().lower()
        
        # æ¸…é™¤ç°æœ‰é¡¹ç›®
        for item in self.invoice_tree.get_children():
            self.invoice_tree.delete(item)
        
        # é‡æ–°æ·»åŠ åŒ¹é…çš„é¡¹ç›®
        for invoice_number, data in self.invoice_data.items():
            if (search_text in invoice_number.lower() or
                search_text in data["customer_name"].lower() or
                search_text in data["customer_cnpj"].lower()):
                
                self.invoice_tree.insert("", tk.END, values=(
                    invoice_number,
                    data["invoice_date"],
                    data["customer_name"],
                    data["customer_cnpj"],
                    data["customer_address"],
                    f"R$ {float(data['total_amount']):,.2f}",
                    f"R$ {float(data['freight']):,.2f}",
                    f"R$ {float(data['discount']):,.2f}",
                    f"{data['icms_rate']}%",
                    f"R$ {float(data['icms_amount']):,.2f}",
                    f"{data['pis_rate']}%",
                    f"R$ {float(data['pis_amount']):,.2f}",
                    f"{data['cofins_rate']}%",
                    f"R$ {float(data['cofins_amount']):,.2f}"
                ))
        
    def _on_search_change(self):
        """å¤„ç†æœç´¢æ–‡æœ¬å˜åŒ–"""
        if hasattr(self, "_search_after"):
            self.after_cancel(self._search_after)
        self._search_after = self.after(300, self._apply_filter)
        
    def _on_invoice_double_click(self, event):
        """å¤„ç†å‘ç¥¨åŒå‡»äº‹ä»¶"""
        item = self.invoice_tree.selection()[0]
        values = self.invoice_tree.item(item)["values"]
        if values:
            self._show_invoice_detail(values[0])  # ä¼ é€’å‘ç¥¨å·ç 
            
    def _show_invoice_detail(self, invoice_number):
        """æ˜¾ç¤ºå‘ç¥¨è¯¦ç»†ä¿¡æ¯"""
        if invoice_number not in self.invoice_data:
            return
            
        data = self.invoice_data[invoice_number]
        
        dialog = tk.Toplevel(self)
        dialog.title(f"å‘ç¥¨è¯¦æƒ… - {invoice_number}")
        dialog.geometry("800x600")
        
        # è®¾ç½®å¯¹è¯æ¡†æ ·å¼
        frame = ttk.Frame(dialog, style="Card.TFrame")
        frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # åˆ›å»ºé€‰é¡¹å¡
        notebook = ttk.Notebook(frame)
        notebook.pack(fill=tk.BOTH, expand=True)
        
        # åŸºæœ¬ä¿¡æ¯é¡µ
        basic_page = ttk.Frame(notebook, style="Card.TFrame")
        notebook.add(basic_page, text="åŸºæœ¬ä¿¡æ¯")
        
        # æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        basic_info = [
            ("å‘ç¥¨å·ç ", invoice_number),
            ("å‘ç¥¨æ—¥æœŸ", data["invoice_date"]),
            ("å®¢æˆ·åç§°", data["customer_name"]),
            ("å®¢æˆ·CNPJ", data["customer_cnpj"]),
            ("å®¢æˆ·åœ°å€", data["customer_address"]),
            ("äº§å“æ€»ä»·", f"R$ {float(data['total_amount']):,.2f}"),
            ("è¿è´¹", f"R$ {float(data['freight']):,.2f}"),
            ("æŠ˜æ‰£", f"R$ {float(data['discount']):,.2f}")
        ]
        
        for i, (label, value) in enumerate(basic_info):
            row = ttk.Frame(basic_page, style="Card.TFrame")
            row.pack(fill=tk.X, pady=2)
            
            ttk.Label(
                row,
                text=f"{label}:",
                style="Header.TLabel"
            ).pack(side=tk.LEFT, padx=5)
            
            ttk.Label(
                row,
                text=str(value),
                style="Value.TLabel"
            ).pack(side=tk.RIGHT, padx=5)
        
        # ç¨æ”¶ä¿¡æ¯é¡µ
        tax_page = ttk.Frame(notebook, style="Card.TFrame")
        notebook.add(tax_page, text="ç¨æ”¶ä¿¡æ¯")
        
        # æ˜¾ç¤ºç¨æ”¶ä¿¡æ¯
        tax_info = [
            ("ICMSç¨ç‡", f"{data['icms_rate']}%"),
            ("ICMSç¨é¢", f"R$ {float(data['icms_amount']):,.2f}"),
            ("PISç¨ç‡", f"{data['pis_rate']}%"),
            ("PISç¨é¢", f"R$ {float(data['pis_amount']):,.2f}"),
            ("COFINSç¨ç‡", f"{data['cofins_rate']}%"),
            ("COFINSç¨é¢", f"R$ {float(data['cofins_amount']):,.2f}")
        ]
        
        for i, (label, value) in enumerate(tax_info):
            row = ttk.Frame(tax_page, style="Card.TFrame")
            row.pack(fill=tk.X, pady=2)
            
            ttk.Label(
                row,
                text=f"{label}:",
                style="Header.TLabel"
            ).pack(side=tk.LEFT, padx=5)
            
            ttk.Label(
                row,
                text=str(value),
                style="Value.TLabel"
            ).pack(side=tk.RIGHT, padx=5)
        
        # æ·»åŠ å…³é—­æŒ‰é’®
        ttk.Button(
            frame,
            text="å…³é—­",
            command=dialog.destroy,
            style="primary.TButton"
        ).pack(pady=20)
        
        # ä½¿å¯¹è¯æ¡†å±…ä¸­æ˜¾ç¤º
        dialog.transient(self)
        dialog.grab_set()
        self.wait_window(dialog)

    def select_files(self):
        """é€‰æ‹©NFeæ–‡ä»¶"""
        files = filedialog.askopenfilenames(
            title="é€‰æ‹©NFeæ–‡ä»¶",
            filetypes=[("XML files", "*.xml")],
            multiple=True
        )
        
        if not files:
            return
        
        for file_path in files:
            file_name = os.path.basename(file_path)
            try:
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²åŠ è½½
                if file_path in self.loaded_files:
                    messagebox.showwarning("è­¦å‘Š", f"æ–‡ä»¶ {file_name} å·²ç»åŠ è½½")
                    continue
                
                # è§£æXMLæ–‡ä»¶
                tree = ET.parse(file_path)
                
                # æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
                self.file_tree.insert("", tk.END, values=(file_name, "å¤„ç†ä¸­..."))
                self.loaded_files[file_path] = "å¤„ç†ä¸­"
                
                # å¤„ç†XMLæ•°æ®
                self.process_xml(tree)
                
                # æ›´æ–°æ–‡ä»¶çŠ¶æ€
                for item in self.file_tree.get_children():
                    if self.file_tree.item(item)["values"][0] == file_name:
                        self.file_tree.item(item, values=(file_name, "å·²å®Œæˆ"))
                        self.loaded_files[file_path] = "å·²å®Œæˆ"
                        break
            except ET.ParseError:
                messagebox.showerror("é”™è¯¯", f"æ–‡ä»¶ {file_name} ä¸æ˜¯æœ‰æ•ˆçš„XMLæ–‡ä»¶")
                continue
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"å¤„ç†æ–‡ä»¶ {file_name} æ—¶å‡ºé”™: {str(e)}")
                print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")
                import traceback
                traceback.print_exc()
    
    def clear_all(self):
        """æ¸…é™¤æ‰€æœ‰æ•°æ®"""
        if messagebox.askyesno("ç¡®è®¤", "ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ"):
            # æ¸…é™¤æ–‡ä»¶åˆ—è¡¨
            for item in self.file_tree.get_children():
                self.file_tree.delete(item)
            
            # æ¸…é™¤æ•°æ®è¡¨æ ¼
            for item in self.tree.get_children():
                self.tree.delete(item)
            
            # æ¸…é™¤å‘ç¥¨è¡¨æ ¼
            for item in self.invoice_tree.get_children():
                self.invoice_tree.delete(item)
            
            # æ¸…é™¤æ•°æ®
            self.loaded_files.clear()
            self.invoice_data.clear()
            self.summary_labels.clear()
            
            # é‡ç½®æ±‡æ€»æ•°æ®
            self.summary_data = {
                "total_invoices": 0,
                "total_products": 0,
                "total_amount": Decimal('0'),
                "total_icms": Decimal('0'),
                "total_pis": Decimal('0'),
                "total_cofins": Decimal('0'),
                "total_tax": Decimal('0'),
                "avg_product_price": Decimal('0'),
                "max_product_price": Decimal('0'),
                "min_product_price": Decimal('0'),
                "total_discount": Decimal('0'),
                "unique_customers": set(),
                "unique_products": set(),
                "tax_percentage": Decimal('0')
            }
            
            # æ›´æ–°æ˜¾ç¤º
            self.update_summary_display()
            
            # é‡ç½®é˜²æŠ–åŠ¨è®¾ç½®
            self._scroll_update_pending = False
            self._last_scroll_time = 0

    def safe_find_text(self, element, path, ns, default=""):
        """å®‰å…¨è·å–XMLå…ƒç´ æ–‡æœ¬"""
        if element is None:
            return default
        node = element.find(path, ns)
        return node.text if node is not None else default
    
    def safe_find_decimal(self, element, path, ns):
        """å®‰å…¨è·å–XMLå…ƒç´ çš„Decimalå€¼"""
        if element is None:
            return Decimal('0')
        node = element.find(path, ns)
        try:
            return Decimal(node.text) if node is not None else Decimal('0')
        except:
            return Decimal('0')
    
    def format_date(self, date_str):
        """æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²"""
        try:
            if not date_str:
                return ""
            # å¤„ç†å¸¦æ—¶åŒºçš„æ—¥æœŸæ—¶é—´
            if "T" in date_str:
                dt = datetime.strptime(date_str.split("T")[0], "%Y-%m-%d")
            else:
                dt = datetime.strptime(date_str, "%Y-%m-%d")
            return dt.strftime("%Y-%m-%d")
        except:
            return date_str

    def get_tp_imp_desc(self, tp_imp):
        """è·å–æ‰“å°ç±»å‹æè¿°"""
        types = {
            "1": "æ™®é€šæ‰“å°",
            "2": "DANFEç®€åŒ–",
            "3": "DANFE NFC-e",
            "4": "DANFE NFC-eæ‰‹æœº",
            "5": "DANFE NFC-eé‚®ä»¶"
        }
        return types.get(tp_imp, "æœªçŸ¥")
        
    def get_tp_emis_desc(self, tp_emis):
        """è·å–å‡ºå…·ç±»å‹æè¿°"""
        types = {
            "1": "æ­£å¸¸å‡ºå…·",
            "2": "åº”æ€¥å‡ºå…·",
            "3": "SCANå‡ºå…·",
            "4": "DPECå‡ºå…·",
            "5": "åº”æ€¥å‡ºå…·FS-DA",
            "6": "SVC-ANå‡ºå…·",
            "7": "SVC-RSå‡ºå…·",
            "8": "SVCSPå‡ºå…·",
            "9": "ç¦»çº¿åº”æ€¥"
        }
        return types.get(tp_emis, "æœªçŸ¥")

    def export_to_excel(self):
        """å¯¼å‡ºæ•°æ®åˆ°Excelæ–‡ä»¶"""
        if not self.invoice_data:
            messagebox.showwarning("è­¦å‘Š", "æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º")
            return
        
        try:
            # åˆ›å»ºæ–°çš„å·¥ä½œç°¿
            wb = openpyxl.Workbook()
            
            # åˆ›å»ºå‘ç¥¨æ˜ç»†è¡¨
            self.create_invoice_detail_sheet(wb)
            
            # åˆ›å»ºå‘ç¥¨æ±‡æ€»è¡¨
            self.create_invoice_summary_sheet(wb)
            
            # åˆ é™¤é»˜è®¤çš„Sheet
            if "Sheet" in wb.sheetnames:
                wb.remove(wb["Sheet"])
            
            # ä¿å­˜æ–‡ä»¶
            filename = filedialog.asksaveasfilename(
                defaultextension=".xlsx",
                filetypes=[("Excel files", "*.xlsx")],
                title="ä¿å­˜Excelæ–‡ä»¶"
            )
            
            if filename:
                wb.save(filename)
                messagebox.showinfo("æˆåŠŸ", "æ•°æ®å·²æˆåŠŸå¯¼å‡ºåˆ°Excelæ–‡ä»¶")
        
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯¼å‡ºExcelæ—¶å‡ºé”™: {str(e)}")

    def create_invoice_detail_sheet(self, wb):
        """åˆ›å»ºå‘ç¥¨æ˜ç»†è¡¨"""
        ws = wb.create_sheet("å‘ç¥¨æ˜ç»†")
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        headers = [
            "å‘ç¥¨å·ç ", "å‘ç¥¨æ—¥æœŸ", "å®¢æˆ·åç§°", "å®¢æˆ·CNPJ", "å®¢æˆ·åœ°å€",
            "äº§å“ä»£ç ", "äº§å“åç§°", "NCM", "æ•°é‡", "å•ä»·", "æ€»ä»·",
            "ICMSç¨ç‡", "ICMSç¨é¢", "PISç¨ç‡", "PISç¨é¢",
            "COFINSç¨ç‡", "COFINSç¨é¢"
        ]
        
        # è®¾ç½®æ ‡é¢˜æ ·å¼
        header_font = Font(bold=True, size=11)
        header_fill = PatternFill(start_color="CCE5FF", end_color="CCE5FF", fill_type="solid")
        header_alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
        
        # å†™å…¥æ ‡é¢˜
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = header_alignment
            ws.column_dimensions[get_column_letter(col)].width = 15
        
        # å†™å…¥æ•°æ®
        row = 2
        for item in self.tree.get_children():
            values = self.tree.item(item)["values"]
            for col, value in enumerate(values[:len(headers)], 1):
                cell = ws.cell(row=row, column=col, value=value)
                cell.alignment = Alignment(horizontal="left")
            row += 1

    def create_invoice_summary_sheet(self, wb):
        """åˆ›å»ºå‘ç¥¨æ±‡æ€»è¡¨"""
        ws = wb.create_sheet("å‘ç¥¨æ±‡æ€»")
        
        # è®¾ç½®åˆ—æ ‡é¢˜
        headers = [
            "å‘ç¥¨å·ç ", "å‘ç¥¨æ—¥æœŸ", "å®¢æˆ·åç§°", "å®¢æˆ·CNPJ", "å®¢æˆ·åœ°å€",
            "äº§å“æ€»ä»·", "è¿è´¹", "æŠ˜æ‰£", "ICMSç¨ç‡", "ICMSç¨é¢",
            "PISç¨ç‡", "PISç¨é¢", "COFINSç¨ç‡", "COFINSç¨é¢"
        ]
        
        # è®¾ç½®æ ‡é¢˜æ ·å¼
        header_font = Font(bold=True, size=11)
        header_fill = PatternFill(start_color="CCE5FF", end_color="CCE5FF", fill_type="solid")
        header_alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
        
        # å†™å…¥æ ‡é¢˜
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = header_alignment
            ws.column_dimensions[get_column_letter(col)].width = 15
        
        # å†™å…¥æ•°æ®
        row = 2
        for item in self.invoice_tree.get_children():
            values = self.invoice_tree.item(item)["values"]
            for col, value in enumerate(values[:len(headers)], 1):
                cell = ws.cell(row=row, column=col, value=value)
                cell.alignment = Alignment(horizontal="left")
            row += 1

    def _on_mousewheel(self, event):
        """å¤„ç†é¼ æ ‡æ»šè½®äº‹ä»¶"""
        # è·å–å½“å‰æ“ä½œç³»ç»Ÿ
        if sys.platform.startswith('win'):
            # Windowsç³»ç»Ÿ
            delta = -int(event.delta/120)
        else:
            # Linuxå’ŒmacOSç³»ç»Ÿ
            delta = event.delta
        
        # è®¡ç®—æ»šåŠ¨çš„å•ä½ï¼ˆæ¯æ¬¡æ»šåŠ¨3è¡Œï¼‰
        scroll_unit = delta * 3
        
        # æ ¹æ®äº‹ä»¶çš„widgetæ¥ç¡®å®šè¦æ»šåŠ¨çš„ç»„ä»¶
        widget = event.widget
        
        if widget == self.tree:
            # æ•°æ®è¡¨æ ¼æ»šåŠ¨
            self.tree.yview_scroll(scroll_unit, "units")
        elif widget == self.invoice_tree:
            # å‘ç¥¨è¡¨æ ¼æ»šåŠ¨
            self.invoice_tree.yview_scroll(scroll_unit, "units")
        elif widget == self.file_tree:
            # æ–‡ä»¶åˆ—è¡¨æ»šåŠ¨
            self.file_tree.yview_scroll(scroll_unit, "units")
            
    def _bind_mousewheel(self, event):
        """ç»‘å®šé¼ æ ‡æ»šè½®äº‹ä»¶"""
        # å½“é¼ æ ‡è¿›å…¥ç»„ä»¶æ—¶ç»‘å®šæ»šè½®äº‹ä»¶
        event.widget.bind_all("<MouseWheel>", self._on_mousewheel)
        
    def _unbind_mousewheel(self, event):
        """è§£ç»‘é¼ æ ‡æ»šè½®äº‹ä»¶"""
        # å½“é¼ æ ‡ç¦»å¼€ç»„ä»¶æ—¶è§£ç»‘æ»šè½®äº‹ä»¶
        event.widget.unbind_all("<MouseWheel>")

    def _on_shift_mousewheel(self, event):
        """å¤„ç†Shift+é¼ æ ‡æ»šè½®äº‹ä»¶ï¼ˆç”¨äºæ°´å¹³æ»šåŠ¨ï¼‰"""
        # è·å–å½“å‰æ“ä½œç³»ç»Ÿ
        if sys.platform.startswith('win'):
            # Windowsç³»ç»Ÿ
            delta = -int(event.delta/120)
        else:
            # Linuxå’ŒmacOSç³»ç»Ÿ
            delta = event.delta
        
        # è®¡ç®—æ»šåŠ¨çš„å•ä½ï¼ˆæ¯æ¬¡æ»šåŠ¨3åˆ—ï¼‰
        scroll_unit = delta * 3
        
        # æ ¹æ®äº‹ä»¶çš„widgetæ¥ç¡®å®šè¦æ»šåŠ¨çš„ç»„ä»¶
        widget = event.widget
        
        if widget == self.tree:
            # æ•°æ®è¡¨æ ¼æ°´å¹³æ»šåŠ¨
            self.tree.xview_scroll(scroll_unit, "units")
        elif widget == self.invoice_tree:
            # å‘ç¥¨è¡¨æ ¼æ°´å¹³æ»šåŠ¨
            self.invoice_tree.xview_scroll(scroll_unit, "units")
            
    def _bind_shift_mousewheel(self, event):
        """ç»‘å®šShift+é¼ æ ‡æ»šè½®äº‹ä»¶"""
        # å½“é¼ æ ‡è¿›å…¥ç»„ä»¶æ—¶ç»‘å®šShift+æ»šè½®äº‹ä»¶
        event.widget.bind_all("<Shift-MouseWheel>", self._on_shift_mousewheel)
        
    def _unbind_shift_mousewheel(self, event):
        """è§£ç»‘Shift+é¼ æ ‡æ»šè½®äº‹ä»¶"""
        # å½“é¼ æ ‡ç¦»å¼€ç»„ä»¶æ—¶è§£ç»‘Shift+æ»šè½®äº‹ä»¶
        event.widget.unbind_all("<Shift-MouseWheel>")

    def _debounced_scroll(self, scrollbar, *args):
        """é˜²æŠ–åŠ¨æ»šåŠ¨å¤„ç†"""
        if not hasattr(self, '_scroll_after_id'):
            self._scroll_after_id = None
            
        # å–æ¶ˆä¹‹å‰çš„å¾…æ‰§è¡Œæ»šåŠ¨
        if self._scroll_after_id:
            self.after_cancel(self._scroll_after_id)
            
        # å»¶è¿Ÿæ‰§è¡Œæ»šåŠ¨
        def update_scroll():
            scrollbar.set(*args)
            self._scroll_after_id = None
            
        self._scroll_after_id = self.after(10, update_scroll)

    def process_xml(self, tree):
        """å¤„ç†XMLæ–‡ä»¶"""
        try:
            # å®šä¹‰å‘½åç©ºé—´
            ns = {'nfe': 'http://www.portalfiscal.inf.br/nfe'}
            
            # è·å–æ ¹å…ƒç´ å’Œå¿…è¦èŠ‚ç‚¹
            root = tree.getroot()
            nfe = root.find('.//nfe:NFe', ns)
            if nfe is None:
                raise ValueError("æ‰¾ä¸åˆ°NFeèŠ‚ç‚¹")
            
            inf_nfe = nfe.find('.//nfe:infNFe', ns)
            if inf_nfe is None:
                raise ValueError("æ‰¾ä¸åˆ°infNFeèŠ‚ç‚¹")
            
            # è·å–ideèŠ‚ç‚¹ï¼ˆæ ‡è¯†ä¿¡æ¯ï¼‰
            ide = inf_nfe.find('nfe:ide', ns)
            if ide is None:
                raise ValueError("æ‰¾ä¸åˆ°ideèŠ‚ç‚¹")
            
            # è·å–åŸºæœ¬ä¿¡æ¯
            invoice_number = self.safe_find_text(ide, 'nfe:nNF', ns)
            series = self.safe_find_text(ide, 'nfe:serie', ns)
            date = self.format_date(self.safe_find_text(ide, 'nfe:dhEmi', ns))
            nat_op = self.safe_find_text(ide, 'nfe:natOp', ns)
            tp_imp = self.get_tp_imp_desc(self.safe_find_text(ide, 'nfe:tpImp', ns))
            tp_emis = self.get_tp_emis_desc(self.safe_find_text(ide, 'nfe:tpEmis', ns))
            
            # è·å–å®¢æˆ·ä¿¡æ¯
            dest = inf_nfe.find('nfe:dest', ns)
            if dest is None:
                raise ValueError("æ‰¾ä¸åˆ°destèŠ‚ç‚¹")
            
            customer_name = self.safe_find_text(dest, 'nfe:xNome', ns)
            customer_cnpj = self.safe_find_text(dest, 'nfe:CNPJ', ns)
            
            # è·å–å®¢æˆ·åœ°å€
            ender_dest = dest.find('nfe:enderDest', ns)
            if ender_dest is not None:
                address_parts = [
                    self.safe_find_text(ender_dest, 'nfe:xLgr', ns),
                    self.safe_find_text(ender_dest, 'nfe:nro', ns),
                    self.safe_find_text(ender_dest, 'nfe:xBairro', ns),
                    self.safe_find_text(ender_dest, 'nfe:xMun', ns),
                    self.safe_find_text(ender_dest, 'nfe:UF', ns),
                    self.safe_find_text(ender_dest, 'nfe:CEP', ns)
                ]
                customer_address = ', '.join(filter(None, address_parts))
            else:
                customer_address = ""
            
            # è·å–æ€»è®¡ä¿¡æ¯
            total = inf_nfe.find('.//nfe:total/nfe:ICMSTot', ns)
            if total is None:
                raise ValueError("æ‰¾ä¸åˆ°totalèŠ‚ç‚¹")
            
            # è·å–å•†å“ä¿¡æ¯
            items = inf_nfe.findall('.//nfe:det', ns)
            
            # æ›´æ–°åŸºæœ¬ç»Ÿè®¡
            print(f"å¤„ç†å‘ç¥¨ {invoice_number}")
            print(f"æ›´æ–°å‰ç»Ÿè®¡æ•°æ®: {self.summary_data}")
            
            self.summary_data["total_invoices"] += 1
            self.summary_data["total_products"] += len(items)
            
            # æ›´æ–°é‡‘é¢ç»Ÿè®¡
            total_amount = self.safe_find_decimal(total, 'nfe:vNF', ns)
            total_icms = self.safe_find_decimal(total, 'nfe:vICMS', ns)
            total_pis = self.safe_find_decimal(total, 'nfe:vPIS', ns)
            total_cofins = self.safe_find_decimal(total, 'nfe:vCOFINS', ns)
            total_discount = self.safe_find_decimal(total, 'nfe:vDesc', ns)
            
            self.summary_data["total_amount"] += total_amount
            self.summary_data["total_icms"] += total_icms
            self.summary_data["total_pis"] += total_pis
            self.summary_data["total_cofins"] += total_cofins
            self.summary_data["total_tax"] += (total_icms + total_pis + total_cofins)
            self.summary_data["total_discount"] += total_discount
            
            # æ›´æ–°å®¢æˆ·ç»Ÿè®¡
            if customer_cnpj:
                self.summary_data["unique_customers"].add(customer_cnpj)
            
            # æ›´æ–°å‘ç¥¨æ•°æ®
            self.invoice_data[invoice_number] = {
                "invoice_date": date,
                "customer_name": customer_name,
                "customer_cnpj": customer_cnpj,
                "customer_address": customer_address,
                "total_amount": total_amount,
                "freight": self.safe_find_decimal(total, 'nfe:vFrete', ns),
                "discount": total_discount,
                "icms_rate": "0",
                "icms_amount": total_icms,
                "pis_rate": "0",
                "pis_amount": total_pis,
                "cofins_rate": "0",
                "cofins_amount": total_cofins
            }
            
            # å¤„ç†å•†å“ä¿¡æ¯
            for item in items:
                prod = item.find('nfe:prod', ns)
                if prod is not None:
                    # è·å–å•†å“åŸºæœ¬ä¿¡æ¯
                    product_code = self.safe_find_text(prod, 'nfe:cProd', ns)
                    product_name = self.safe_find_text(prod, 'nfe:xProd', ns)
                    ncm = self.safe_find_text(prod, 'nfe:NCM', ns)
                    quantity = self.safe_find_decimal(prod, 'nfe:qCom', ns)
                    unit_price = self.safe_find_decimal(prod, 'nfe:vUnCom', ns)
                    total_price = self.safe_find_decimal(prod, 'nfe:vProd', ns)
                    
                    # è·å–ICMSä¿¡æ¯
                    icms = item.find('.//nfe:ICMS', ns)
                    icms_rate = "0"
                    icms_amount = Decimal('0')
                    
                    if icms is not None:
                        for icms_type in ['ICMS00', 'ICMS10', 'ICMS20', 'ICMS30', 'ICMS40', 'ICMS50', 'ICMS60', 'ICMS70', 'ICMS90']:
                            icms_group = icms.find(f'nfe:{icms_type}', ns)
                            if icms_group is not None:
                                icms_rate = self.safe_find_text(icms_group, 'nfe:pICMS', ns)
                                icms_amount = self.safe_find_decimal(icms_group, 'nfe:vICMS', ns)
                                break
                    
                    # è·å–PISä¿¡æ¯
                    pis = item.find('.//nfe:PIS', ns)
                    pis_rate = "0"
                    pis_amount = Decimal('0')
                    
                    if pis is not None:
                        pis_group = pis.find('nfe:PISAliq', ns)
                        if pis_group is not None:
                            pis_rate = self.safe_find_text(pis_group, 'nfe:pPIS', ns)
                            pis_amount = self.safe_find_decimal(pis_group, 'nfe:vPIS', ns)
                    
                    # è·å–COFINSä¿¡æ¯
                    cofins = item.find('.//nfe:COFINS', ns)
                    cofins_rate = "0"
                    cofins_amount = Decimal('0')
                    
                    if cofins is not None:
                        cofins_group = cofins.find('nfe:COFINSAliq', ns)
                        if cofins_group is not None:
                            cofins_rate = self.safe_find_text(cofins_group, 'nfe:pCOFINS', ns)
                            cofins_amount = self.safe_find_decimal(cofins_group, 'nfe:vCOFINS', ns)
                    
                    # æ·»åŠ åˆ°æ•°æ®è¡¨æ ¼
                    self.tree.insert("", tk.END, values=(
                        invoice_number, series, date, nat_op, tp_imp, tp_emis,
                        customer_name, customer_cnpj, customer_address,
                        product_code, product_name, ncm,
                        float(quantity), float(unit_price), float(total_price),
                        icms_rate, float(icms_amount),
                        pis_rate, float(pis_amount),
                        cofins_rate, float(cofins_amount)
                    ))
                    
                    # æ›´æ–°å•†å“ç»Ÿè®¡
                    if product_code:
                        self.summary_data["unique_products"].add(product_code)
                    
                    # æ›´æ–°ä»·æ ¼ç»Ÿè®¡
                    if unit_price > Decimal('0'):
                        if self.summary_data["max_product_price"] == Decimal('0') or unit_price > self.summary_data["max_product_price"]:
                            self.summary_data["max_product_price"] = unit_price
                        if self.summary_data["min_product_price"] == Decimal('0') or unit_price < self.summary_data["min_product_price"]:
                            self.summary_data["min_product_price"] = unit_price
            
            # è®¡ç®—å¹³å‡ä»·æ ¼
            if self.summary_data["total_products"] > 0:
                self.summary_data["avg_product_price"] = self.summary_data["total_amount"] / Decimal(str(self.summary_data["total_products"]))
            
            # è®¡ç®—ç¨æ”¶å æ¯”
            if self.summary_data["total_amount"] > Decimal('0'):
                self.summary_data["tax_percentage"] = (self.summary_data["total_tax"] / self.summary_data["total_amount"]) * Decimal('100')
            
            print(f"æ›´æ–°åç»Ÿè®¡æ•°æ®: {self.summary_data}")
            
            # æ›´æ–°å‘ç¥¨åˆ—è¡¨
            self.invoice_tree.insert("", tk.END, values=(
                invoice_number,
                date,
                customer_name,
                customer_cnpj,
                customer_address,
                f"R$ {float(total_amount):,.2f}",
                f"R$ {float(self.invoice_data[invoice_number]['freight']):,.2f}",
                f"R$ {float(total_discount):,.2f}",
                f"{icms_rate}%",
                f"R$ {float(total_icms):,.2f}",
                f"{pis_rate}%",
                f"R$ {float(total_pis):,.2f}",
                f"{cofins_rate}%",
                f"R$ {float(total_cofins):,.2f}"
            ))
            
            # æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            self.update_summary_display()
            
            # å¼ºåˆ¶æ›´æ–°ç•Œé¢
            self.update()
            self.update_idletasks()
            
        except Exception as e:
            print(f"å¤„ç†XMLæ—¶å‡ºé”™: {str(e)}")
            import traceback
            traceback.print_exc()
            raise

    def update_invoice_display(self):
        """æ›´æ–°å‘ç¥¨æ˜¾ç¤º"""
        try:
            # æ¸…é™¤ç°æœ‰æ•°æ®
            for item in self.invoice_tree.get_children():
                self.invoice_tree.delete(item)
            
            # é‡æ–°å¡«å……æ•°æ®
            for invoice_number, data in self.invoice_data.items():
                self.invoice_tree.insert("", tk.END, values=(
                    invoice_number,
                    data["invoice_date"],
                    data["customer_name"],
                    data["customer_cnpj"],
                    data["customer_address"],
                    f"R$ {float(data['total_amount']):,.2f}",
                    f"R$ {float(data['freight']):,.2f}",
                    f"R$ {float(data['discount']):,.2f}",
                    f"{data['icms_rate']}%",
                    f"R$ {float(data['icms_amount']):,.2f}",
                    f"{data['pis_rate']}%",
                    f"R$ {float(data['pis_amount']):,.2f}",
                    f"{data['cofins_rate']}%",
                    f"R$ {float(data['cofins_amount']):,.2f}"
                ))
        except Exception as e:
            print(f"æ›´æ–°å‘ç¥¨æ˜¾ç¤ºæ—¶å‡ºé”™: {str(e)}")

    def create_summary_page(self):
        """åˆ›å»ºç»Ÿè®¡åˆ†æé¡µé¢"""
        summary_page = ttk.Frame(self.notebook, style="Card.TFrame")
        self.notebook.add(summary_page, text="ç»Ÿè®¡åˆ†æ")
        
        # åˆ›å»ºå·¦å³å¸ƒå±€
        left_frame = ttk.Frame(summary_page, style="Card.TFrame")
        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(10, 5), pady=10)
        
        right_frame = ttk.Frame(summary_page, style="Card.TFrame")
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(5, 10), pady=10)
        
        # åˆ›å»ºç»Ÿè®¡å¡ç‰‡
        self.create_basic_stats_card(left_frame)
        self.create_tax_stats_card(left_frame)
        self.create_product_stats_card(right_frame)
        self.create_customer_stats_card(right_frame)

    def create_basic_stats_card(self, parent):
        """åˆ›å»ºåŸºæœ¬ç»Ÿè®¡å¡ç‰‡"""
        card = ttk.LabelFrame(parent, text="åŸºæœ¬ç»Ÿè®¡", style="Card.TLabelframe")
        card.pack(fill=tk.X, pady=(0, 10), ipadx=10, ipady=5)
        
        stats = [
            ("total_invoices", "æ€»å‘ç¥¨æ•°", "ä»¶"),
            ("total_products", "æ€»å•†å“æ•°", "ä»¶"),
            ("total_amount", "æ€»é‡‘é¢", "R$", True)
        ]
        
        for key, label, unit, *args in stats:
            self.create_stat_row(card, key, label, unit, is_currency=bool(args))

    def create_tax_stats_card(self, parent):
        """åˆ›å»ºç¨æ”¶ç»Ÿè®¡å¡ç‰‡"""
        card = ttk.LabelFrame(parent, text="ç¨æ”¶ç»Ÿè®¡", style="Card.TLabelframe")
        card.pack(fill=tk.X, pady=(0, 10), ipadx=10, ipady=5)
        
        stats = [
            ("total_icms", "ICMSç¨é¢", "R$", True),
            ("total_pis", "PISç¨é¢", "R$", True),
            ("total_cofins", "COFINSç¨é¢", "R$", True),
            ("total_tax", "æ€»ç¨é¢", "R$", True),
            ("tax_percentage", "ç¨æ”¶å æ¯”", "%")
        ]
        
        for key, label, unit, *args in stats:
            self.create_stat_row(card, key, label, unit, is_currency=bool(args))

    def create_product_stats_card(self, parent):
        """åˆ›å»ºå•†å“ç»Ÿè®¡å¡ç‰‡"""
        card = ttk.LabelFrame(parent, text="å•†å“ç»Ÿè®¡", style="Card.TLabelframe")
        card.pack(fill=tk.X, pady=(0, 10), ipadx=10, ipady=5)
        
        stats = [
            ("unique_products", "å•†å“ç§ç±»", "ç§"),
            ("avg_product_price", "å¹³å‡å•ä»·", "R$", True),
            ("max_product_price", "æœ€é«˜å•ä»·", "R$", True),
            ("min_product_price", "æœ€ä½å•ä»·", "R$", True),
            ("total_discount", "æ€»æŠ˜æ‰£", "R$", True)
        ]
        
        for key, label, unit, *args in stats:
            self.create_stat_row(card, key, label, unit, is_currency=bool(args))

    def create_customer_stats_card(self, parent):
        """åˆ›å»ºå®¢æˆ·ç»Ÿè®¡å¡ç‰‡"""
        card = ttk.LabelFrame(parent, text="å®¢æˆ·ç»Ÿè®¡", style="Card.TLabelframe")
        card.pack(fill=tk.X, pady=(0, 10), ipadx=10, ipady=5)
        
        self.create_stat_row(card, "unique_customers", "å®¢æˆ·æ•°é‡", "ä¸ª")

    def create_stat_row(self, parent, key, label_text, unit, is_currency=False):
        """åˆ›å»ºç»Ÿè®¡è¡Œ"""
        frame = ttk.Frame(parent, style="Card.TFrame")
        frame.pack(fill=tk.X, pady=2)
        
        # åˆ›å»ºæ ‡ç­¾å®¹å™¨
        label_container = ttk.Frame(frame, style="Card.TFrame")
        label_container.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
        
        # æ·»åŠ å›¾æ ‡
        icon_label = ttk.Label(
            label_container,
            text="ğŸ“Š",
            style="Header.TLabel"
        )
        icon_label.pack(side=tk.LEFT, padx=(0, 5))
        
        # æ·»åŠ æ ‡ç­¾æ–‡æœ¬
        label = ttk.Label(
            label_container,
            text=f"{label_text}:",
            style="Header.TLabel"
        )
        label.pack(side=tk.LEFT)
        
        # åˆ›å»ºå€¼å®¹å™¨
        value_container = ttk.Frame(frame, style="Card.TFrame")
        value_container.pack(side=tk.RIGHT, padx=5)
        
        # åˆ›å»ºå€¼æ ‡ç­¾
        value_label = ttk.Label(
            value_container,
            text="0" if not is_currency else "R$ 0.00",
            style="Value.TLabel"
        )
        value_label.pack(side=tk.LEFT)
        
        # æ·»åŠ å•ä½æ ‡ç­¾
        if unit:
            unit_label = ttk.Label(
                value_container,
                text=f" {unit}",
                style="Value.TLabel"
            )
            unit_label.pack(side=tk.LEFT)
        
        # å­˜å‚¨æ ‡ç­¾å¼•ç”¨
        self.summary_labels[key] = value_label
        
        return value_label

    def update_summary_display(self):
        """æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º"""
        try:
            print("å¼€å§‹æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º")
            print(f"å½“å‰ç»Ÿè®¡æ•°æ®: {self.summary_data}")
            
            # æ›´æ–°æ‰€æœ‰ç»Ÿè®¡æ ‡ç­¾
            for key, value in self.summary_data.items():
                if key in self.summary_labels:
                    label = self.summary_labels[key]
                    if isinstance(value, set):
                        label.configure(text=str(len(value)))
                    elif isinstance(value, Decimal):
                        if key == "tax_percentage":
                            label.configure(text=f"{float(value):.1f}")
                        else:
                            label.configure(text=f"R$ {float(value):,.2f}")
                    else:
                        label.configure(text=str(value))
                    print(f"æ›´æ–° {key}: {value}")
            
            # å¼ºåˆ¶æ›´æ–°æ˜¾ç¤º
            self.update_idletasks()
            
        except Exception as e:
            print(f"æ›´æ–°ç»Ÿè®¡æ˜¾ç¤ºæ—¶å‡ºé”™: {str(e)}")
            import traceback
            traceback.print_exc()
    ```



